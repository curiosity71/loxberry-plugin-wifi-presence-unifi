<h1><TMPL_VAR SETTINGS.HEADING_BASICSETTINGS></h1>

<p><TMPL_VAR SETTINGS.INTRODUCTION></p>

<form id="WifiPresenceUnifiSettings" onsubmit="return false;"
	style="margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
	<div>
		<label for="url">
			<TMPL_VAR SETTINGS.URL>
		</label>
		<input name="url" id="url" type="text" placeholder="Enter URL"
			style="width: 100%; padding: 10px; margin: 10px 0;" />

		<label for="username">
			<TMPL_VAR SETTINGS.USERNAME>
		</label>
		<input name="username" id="username" type="text" placeholder="Enter Username"
			style="width: 100%; padding: 10px; margin: 10px 0;" />

		<label for="password">
			<TMPL_VAR SETTINGS.PASSWORD>
		</label>
		<input name="password" id="password" type="password" placeholder="Enter Password"
			style="width: 100%; padding: 10px; margin: 10px 0;" />

		<label for="sitename">
			<TMPL_VAR SETTINGS.SITENAME>
		</label>
		<input name="sitename" id="sitename" type="text" placeholder="Enter Sitename"
			style="width: 100%; padding: 10px; margin: 10px 0;" />

		<label for="version">
			<TMPL_VAR SETTINGS.VERSION>
		</label>
		<input name="version" id="version" type="text" placeholder="Enter Version"
			style="width: 100%; padding: 10px; margin: 10px 0;" />
			
		<label for="mqtt_topic_base">
			<TMPL_VAR SETTINGS.MQTT_TOPIC_BASE>
		</label>
		<select name="mqtt_topic_base" id="mqtt_topic_base" style="width: 100%; padding: 10px; margin: 10px 0;">
			<option value="mac"><TMPL_VAR SETTINGS.MQTT_TOPIC_MAC></option>
			<option value="name"><TMPL_VAR SETTINGS.MQTT_TOPIC_NAME></option>
		</select>		
			
		<label>
			<TMPL_VAR SETTINGS.DEVICES_LABEL>
		</label>
		<div id="device_list_container" style="border: 1px solid #ccc; padding: 10px; max-height: 350px; overflow-y: auto; background: #f9f9f9; border-radius: 5px;">
			<i style="color: #666;"><TMPL_VAR SETTINGS.DEVICES_HINT></i>
		</div>
		<button class="ui-btn ui-btn-icon-right" id="fetch_devices" style="margin-top: 10px; background-color: #e0e0e0;"><TMPL_VAR SETTINGS.DEVICES_FETCH_BTN></button>
	</div>

	<p name="status" id="status" style="color: red; text-align: center;"></p>
</form>
 
<br />
<div style="display:flex;align-items:center;justify-content:center;">
	<button class="ui-btn" id="saveaction" data-inline="true"><TMPL_VAR SETTINGS.SAVESETTINGS></button>
	<button class="ui-btn" id="poll" data-inline="true"><TMPL_VAR SETTINGS.FORCEPOLL></button>
</div>

<div style="display:flex;align-items:center;justify-content:center;" id="ajaxresult"></div>


<style>
textarea {
  font-family: sans-serif;
  font-size: 15px !important; line-height: 27px !important;
  padding-top: 0px !important;
  padding-bottom: 0px !important;
  margin-top: 8px !important; 
  margin-bottom: 8px !important; 
}
textarea {
  border: none; outline: none;
  background: repeating-linear-gradient(
    to bottom, transparent, transparent 26px, #6dac20  27px
  );
  background-attachment: local;
}
</style>



<script>
	var cfg;
	var lbversion = '<TMPL_VAR LBVERSION>';
	var jsonbackend_read = '/admin/system/ajax/ajax-generic.php?file=LBPCONFIG/wifi-presence-unifi/config.json&section=Main&read';
	var jsonbackend_write = '/admin/system/ajax/ajax-generic.php?file=LBPCONFIG/wifi-presence-unifi/config.json&section=Main&replace';
	
	$(document).ready(function () {
		// Read config
		$.ajax({
			url: jsonbackend_read,
			type: 'POST',
			dataType: 'json',
			success: function (response) {
				console.log(response); // Überprüfen der Struktur des response-Objekts

				// Fill the form fields with the corresponding values from the JSON response
				$('#url').val(response.url);
				$('#username').val(response.username);
				$('#password').val(response.password);
				$('#sitename').val(response.sitename);
				$('#version').val(response.version);
				if (response.mqtt_topic_base) {
					$('#mqtt_topic_base').val(response.mqtt_topic_base);
				} else {
					$('#mqtt_topic_base').val('mac'); // Standardwert
				}

				// Gespeicherte MACs in einer globalen Variable ablegen, damit wir sie später beim Neuladen der Liste anhaken können
				window.savedMacAddresses = response.macaddresses && Array.isArray(response.macaddresses) ? response.macaddresses : [];
				
				if (window.savedMacAddresses.length > 0) {
					$('#device_list_container').html('<i style="color: #666;">Es sind ' + window.savedMacAddresses.length + ' Geräte gespeichert. Klicke auf "Geräteliste von UniFi abrufen" um die Liste anzuzeigen und zu bearbeiten.</i>');
				}
			},
			error: function (xhr, status, error) {
				// Handle error
				$('#status').text('Error loading configuration: ' + error);
			}
		});
	});


	$("#fetch_devices").click(function (e) {
		e.preventDefault();
		$("#fetch_devices").text("<TMPL_VAR SETTINGSJS.DEVICES_LOADING>").attr("disabled", true);
		$("#device_list_container").html('<i><TMPL_VAR SETTINGSJS.DEVICES_CONNECTING></i>');
			
		$.ajax('process.php', {
			type: 'POST',
			data: { action: 'getclients' },
			dataType: 'json'
		})
		.done(function(clients) {
			var html = '';
			if(clients.length === 0) {
				html = '<i><TMPL_VAR SETTINGSJS.DEVICES_NOTFOUND></i>';
			} else {
				clients.forEach(function(client) {
					var isChecked = window.savedMacAddresses.includes(client.mac) ? 'checked' : '';
					html += '<div style="margin-bottom: 5px; display: flex; align-items: center;">';
					html += '<input type="checkbox" name="macaddress_checkbox" value="' + client.mac + '" id="mac_' + client.mac + '" ' + isChecked + ' style="margin-right: 10px; width: 20px; height: 20px;">';
					html += '<label for="mac_' + client.mac + '" style="margin: 0; font-weight: normal; cursor: pointer;"><strong>' + client.name + '</strong> <span style="font-size: 0.8em; color: #888;">(' + client.mac + ')</span></label>';
					html += '</div>';
				});
			}
			$("#device_list_container").html(html);
			$("#fetch_devices").text("<TMPL_VAR SETTINGSJS.DEVICES_RELOAD>").attr("disabled", false);
		})
		.fail(function(xhr) {
			var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "<TMPL_VAR SETTINGSJS.HINT_GENERAL_ERROR>";
			$("#device_list_container").html('<i style="color: red;">' + errorMsg + '</i>');
			$("#fetch_devices").text("<TMPL_VAR SETTINGSJS.DEVICES_RETRY>").attr("disabled", false);
		});
	});		

	
	$("#saveaction").click(function (e) {
		e.preventDefault(); // Prevent the default form submission
		
		var formData = new FormData(document.getElementById('WifiPresenceUnifiSettings'));
		
		// Entferne eventuell vom Formular automatisch gesendete Checkbox-Werte
		formData.delete('macaddress_checkbox');
		formData.delete('macaddresses[]');

		// Hole alle angehakten Checkboxen und hänge sie als Array an das formData Objekt an
		var selectedMacs = [];
		$("input[name='macaddress_checkbox']:checked").each(function() {
			var mac = $(this).val();
			selectedMacs.push(mac);
			formData.append('macaddresses[]', mac);
		});
		
		// Falls nichts angehakt ist (aber die Liste geladen war), müssen wir ein leeres Array schicken
		// Das machen wir, indem wir einfach einen Dummy-Wert senden, oder das Speichern leitet.
		if (selectedMacs.length === 0) {
			formData.append('macaddresses[]', ''); 
		}
		
		// Update der lokalen Speicherung für die UI
		window.savedMacAddresses = selectedMacs;
		
		$.ajax({
			url: jsonbackend_write,
			type: 'POST',
			data: formData,
			contentType: false,
			processData: false,
			success: function () {
				// Display success message with green text when the request is successful
				$("#ajaxresult").css("color", "green").html("<TMPL_VAR SETTINGSJS.SAVING_SUCCESS>");
			},
			error: function () {
				$("#ajaxresult").css("color", "yellow").html("<TMPL_VAR SETTINGSJS.SAVING_ERROR>");
			}
		});
	});


	$("#poll").click(function(){
		$("#poll").attr("disabled", true);
		
		$.ajax('process.php', { 
			type: 'POST',
			data: {action: 'poll'}
		})
		.done(function(resp) {
			$("#ajaxresult").css("color", "green").html("<TMPL_VAR SETTINGSJS.FORCEPOLL_SUCCESS>");
			$("#poll").attr("disabled", false);
		});
	});
	
	
</script>
